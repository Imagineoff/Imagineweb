<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>he will never forget</title>
    <style>
        /* --- GLOBAL & SETUP --- */
        :root {
            --bg-color: #000000;
            --text-color: #cccccc;
            --highlight-color: #990000;
            --pc-bg: #050510;
            --pc-monitor-bg: #1a1a2a;
            --pc-border: #333344;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            visibility: hidden;
            transition: opacity 1s ease-in-out, transform 1.2s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .screen.active {
            opacity: 1;
            visibility: visible;
            z-index: 10;
        }

        button {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2rem;
            background: none;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background: var(--highlight-color);
            color: #ffffff;
            border-color: var(--highlight-color);
        }

        h1 {
            color: var(--highlight-color);
            font-weight: normal;
            margin-bottom: 20px;
        }

        .pc-only { display: none; }
        .mobile-only { display: none; }

        /* --- 1. INTRO SCREEN --- */
        #intro-screen {
            background: #000;
            z-index: 100;
        }

        #studio-logo {
            font-size: 2rem;
            color: #555;
            animation: fadeInOut 5s forwards ease-in-out;
        }

        #device-select {
            margin-top: 30px;
            opacity: 0;
            animation: fadeIn 2s forwards 5s ease-in;
        }

        #device-select h1 {
            font-size: 1.5rem;
            color: var(--text-color);
        }

        #device-select button {
            margin: 0 10px;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- 2. MAIN ROOM --- */
        #room-screen {
            background-image: url('https://i.imgur.com/O9vg7SA.jpeg');
            background-size: cover;
            background-position: center;
            z-index: 5;
            transform: scale(1);
        }

        #computer-hotspot {
            position: absolute;
            /* Visually targeting the PC on the image */
            top: 55%;
            left: 58%;
            width: 28%;
            height: 30%;
            cursor: pointer;
            /* border: 2px dashed rgba(255, 0, 0, 0); */
            transition: background-color 0.3s;
        }

        #computer-hotspot:hover {
            background-color: rgba(255, 0, 0, 0.1);
        }

        /* --- 3. PC VIEW --- */
        #pc-screen {
            background: var(--pc-bg);
            z-index: 20;
            transform: scale(1.1); /* Start slightly zoomed for transition */
        }

        #pc-screen.active {
            transform: scale(1);
        }

        #pc-desktop {
            width: 95%;
            height: 95%;
            max-width: 1200px;
            max-height: 800px;
            background: var(--pc-monitor-bg);
            border: 10px solid #111;
            border-radius: 5px;
            box-shadow: 0 0 30px rgba(150, 150, 250, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        #pc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--pc-border);
            padding-bottom: 10px;
            color: #8899ff;
        }

        #task-count {
            color: #ffff00;
        }

        #task-container {
            flex-grow: 1;
            margin-top: 20px;
            padding: 15px;
            background: #000;
            border: 1px solid var(--pc-border);
            overflow-y: auto;
            font-size: 1.1rem;
        }

        #pc-controls {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid var(--pc-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #pc-power-off {
            background: var(--highlight-color);
            color: white;
            border-color: var(--highlight-color);
            font-size: 0.9rem;
        }
        #pc-power-off:hover {
            background: #ff0000;
        }
        
        #pc-rebooting {
            display: none;
            color: #00ff00;
            font-size: 1.5rem;
            text-align: center;
        }

        #reboot-bar-container {
            width: 80%;
            height: 30px;
            border: 2px solid #00ff00;
            margin-top: 20px;
        }

        #reboot-bar-fill {
            width: 0%;
            height: 100%;
            background: #00ff00;
            transition: width 0.1s linear;
        }

        /* --- PC TASKS STYLING --- */
        .task-description {
            color: #0f0;
            margin-bottom: 20px;
        }

        #task-type-input {
            width: 100%;
            background: #222;
            border: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2rem;
            padding: 10px;
            margin-top: 10px;
        }

        #task-type-code {
            color: #ff0;
            font-size: 1.3rem;
            letter-spacing: 2px;
            word-wrap: break-word;
        }

        #task-reaction-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .reaction-square {
            width: 100px;
            height: 100px;
            background: #333;
            border: 2px solid #555;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .reaction-square.target {
            background: #00ff00;
        }

        #task-memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            max-width: 440px;
            margin-top: 20px;
        }

        .memory-card {
            width: 100px;
            height: 100px;
            background: #444;
            border: 2px solid #777;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            color: #444;
            user-select: none;
            transition: background-color 0.3s, color 0.3s;
        }
        .memory-card.flipped {
            background: #999;
            color: #fff;
        }
        .memory-card.matched {
            background: #0f0;
            color: #000;
            cursor: default;
        }


        /* --- HUD & UI --- */
        #pills-hud {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 30;
            transition: transform 0.2s ease;
        }
        #pills-hud:active {
            transform: translateX(-50%) scale(0.95);
        }

        #pill-icon {
            width: 30px;
            height: 30px;
            filter: brightness(0.8);
        }

        #pill-count {
            font-size: 1.8rem;
            color: #ffffff;
            margin-left: 15px;
            font-weight: bold;
        }

        #mobile-back-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background: rgba(100, 0, 0, 0.7);
            color: #fff;
            border-radius: 5px;
            z-index: 30;
            cursor: pointer;
        }

        #tips-hud {
            position: absolute;
            bottom: 120px;
            width: 100%;
            text-align: center;
            color: #aaa;
            font-size: 1.1rem;
            font-style: italic;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            pointer-events: none;
            z-index: 30;
        }

        /* --- 4. GAME OVER / WIN SCREENS --- */
        #game-over-screen, #win-screen {
            background: #000;
            z-index: 9998;
        }
        #game-over-screen h1, #win-screen h1 {
            text-align: center;
            font-size: 2rem;
        }
        #game-over-screen button, #win-screen button {
            margin-top: 30px;
        }

        /* --- 5. EFFECTS & OVERLAYS --- */
        #flicker-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.05);
            opacity: 0;
            z-index: 2;
            pointer-events: none;
            animation: flicker 4s infinite alternate step-end;
        }
        
        #panic-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 60%, rgba(255,0,0,0.4) 100%);
            opacity: 0;
            z-index: 25;
            pointer-events: none;
            transition: opacity 1s ease;
        }

        /* High Panic Effects */
        .high-panic-blur {
            filter: blur(1px);
        }
        .high-panic-shake {
            animation: shake 0.3s infinite;
        }

        @keyframes flicker {
            0%, 100% { opacity: 0; }
            5% { opacity: 1; }
            10% { opacity: 0; }
            30% { opacity: 1; }
            32% { opacity: 0; }
            60% { opacity: 0; }
            61% { opacity: 0.5; }
            62% { opacity: 0; }
        }

        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(2px, -1px); }
            50% { transform: translate(-1px, 2px); }
            75% { transform: translate(1px, -2px); }
        }

        /* --- 6. JUMPSCARE --- */
        #jumpscare-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 9999;
            display: none;
            background: #000;
        }

        /* --- RESPONSIVENESS --- */
        @media (max-width: 768px) {
            #computer-hotspot {
                top: 50%;
                left: 50%;
                width: 40%;
                height: 35%;
            }
            #pills-hud {
                bottom: 20px;
            }
            #tips-hud {
                bottom: 90px;
                font-size: 0.9rem;
            }
            .reaction-square {
                width: 80px;
                height: 80px;
            }
            .memory-card {
                width: 70px;
                height: 70px;
                font-size: 2rem;
            }
            #task-memory-grid {
                max-width: 320px;
            }
            #pc-desktop {
                width: 100%;
                height: 100%;
                max-width: 100%;
                max-height: 100%;
                border: none;
                border-radius: 0;
            }
            #pc-controls {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>

    <div id="game-container">

        <div id="intro-screen" class="screen active">
            <div id="studio-logo">Silent Studio</div>
            <div id="device-select" style="display: none;">
                <h1>Choose your device:</h1>
                <button id="btn-pc">PC</button> | <button id="btn-mobile">Mobile</button>
            </div>
        </div>

        <div id="room-screen" class="screen">
            <div id="computer-hotspot"></div>
            </div>

        <div id="pc-screen" class="screen">
            <div id="pc-desktop" style="display: none;">
                <div id="pc-header">
                    <h3>TASKS REMAINING: <span id="task-count">10</span></h3>
                    <span id="pc-time">00:00</span>
                </div>
                <div id="task-container">
                    </div>
                <div id="pc-controls">
                    <span class="pc-only">Press ESC to leave PC</span>
                    <span class="mobile-only">Use 'Back' button to leave</span>
                    <button id="pc-power-off">Turn Off PC</button>
                </div>
            </div>
            <div id="pc-rebooting" style="display: none;">
                <p>Rebooting PC...</p>
                <div id="reboot-bar-container">
                    <div id="reboot-bar-fill"></div>
                </div>
            </div>
        </div>

        <div id="game-over-screen" class="screen">
            <h1>GAME OVER</h1>
            <button id="restart-btn">Restart</button>
        </div>

        <div id="win-screen" class="screen">
            <h1>You remembered everything.</h1>
            <h1>But at what cost?</h1>
            <button id="restart-btn-win">Restart</button>
        </div>

        <div id="pills-hud" style="display: none;">
            <img id="pill-icon" src="https://i.imgur.com/vz9eh1m.jpeg" alt="Pills">
            <span id="pill-count">5</span>
        </div>
        
        <div id="mobile-back-btn" class="mobile-only" style="display: none; z-index: 30;">Back</div>
        <div id="tips-hud"></div>
        <div id="flicker-overlay"></div>
        <div id="panic-overlay"></div>

        <video id="jumpscare-video" src="https://files.catbox.moe/cskqo9.mov" playsinline preload="auto"></video>

        <audio id="audio-breathing" src="https://files.catbox.moe/crj8v7.mp3" loop preload="auto"></audio>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM ELEMENTS ---
            const gameContainer = document.getElementById('game-container');
            const screens = {
                intro: document.getElementById('intro-screen'),
                room: document.getElementById('room-screen'),
                pc: document.getElementById('pc-screen'),
                gameOver: document.getElementById('game-over-screen'),
                win: document.getElementById('win-screen')
            };
            const studioLogo = document.getElementById('studio-logo');
            const deviceSelect = document.getElementById('device-select');
            const btnPC = document.getElementById('btn-pc');
            const btnMobile = document.getElementById('btn-mobile');

            const computerHotspot = document.getElementById('computer-hotspot');
            const pillsHUD = document.getElementById('pills-hud');
            const pillCount = document.getElementById('pill-count');
            const mobileBackBtn = document.getElementById('mobile-back-btn');
            const tipsHUD = document.getElementById('tips-hud');

            const pcDesktop = document.getElementById('pc-desktop');
            const pcRebooting = document.getElementById('pc-rebooting');
            const rebootBarFill = document.getElementById('reboot-bar-fill');
            const taskCount = document.getElementById('task-count');
            const pcTime = document.getElementById('pc-time');
            const taskContainer = document.getElementById('task-container');
            const pcPowerOff = document.getElementById('pc-power-off');

            const panicOverlay = document.getElementById('panic-overlay');
            const jumpscareVideo = document.getElementById('jumpscare-video');
            const audioBreathing = document.getElementById('audio-breathing');

            // --- GAME STATE ---
            const gameState = {
                device: 'pc',
                currentView: 'intro',
                panic: 0,
                pills: 5,
                tasksCompleted: 0,
                tasksTotal: 10,
                pcOn: true,
                pcRebooting: false,
                gameRunning: false,
                highPanicActive: false,
                gameOver: false,
                audioCtx: null,
                ambientHum: null,
                timers: {
                    panic: null,
                    tip: null,
                    ambient: null,
                    pcClock: null
                },
                currentTask: null
            };

            const tips = [
                "Take pills to stay calm.",
                "The breathing is getting closer...",
                "You can't stay here forever.",
                "You must complete the tasks.",
                "Turning off the PC helps... but wastes time.",
                "What did you do?",
                "She won't let you forget."
            ];

            // --- INTRO & INIT ---

            // Show device select after logo fades
            setTimeout(() => {
                studioLogo.style.display = 'none';
                deviceSelect.style.display = 'block';
            }, 5100);

            btnPC.addEventListener('click', () => initGame('pc'));
            btnMobile.addEventListener('click', () => initGame('mobile'));

            function initGame(device) {
                gameState.device = device;
                initAudio();
                
                if (device === 'mobile') {
                    document.querySelectorAll('.mobile-only').forEach(el => el.style.display = 'block');
                } else {
                    document.querySelectorAll('.pc-only').forEach(el => el.style.display = 'block');
                }

                pillsHUD.style.display = 'flex';
                showScreen('room');
                startGameLoop();
            }

            // --- AUDIO HANDLING ---
            function initAudio() {
                if (gameState.audioCtx) return;
                try {
                    gameState.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Create low ambient hum
                    const oscillator = gameState.audioCtx.createOscillator();
                    const gainNode = gameState.audioCtx.createGain();
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(50, gameState.audioCtx.currentTime); // 50Hz hum
                    gainNode.gain.setValueAtTime(0.02, gameState.audioCtx.currentTime); // Very quiet
                    oscillator.connect(gainNode).connect(gameState.audioCtx.destination);
                    oscillator.start();
                    gameState.ambientHum = oscillator;

                    // Prepare other sounds
                    audioBreathing.play().then(() => audioBreathing.pause()).catch(e => console.warn("Audio play blocked"));
                    jumpscareVideo.load();

                } catch (e) {
                    console.error("Web Audio API is not supported in this browser", e);
                }
            }

            function playCreakSound() {
                if (!gameState.audioCtx) return;
                try {
                    const duration = 0.3;
                    const sampleRate = gameState.audioCtx.sampleRate;
                    const buffer = gameState.audioCtx.createBuffer(1, sampleRate * duration, sampleRate);
                    const data = buffer.getChannelData(0);

                    for (let i = 0; i < data.length; i++) {
                        data[i] = (Math.random() * 2 - 1) * (1 - i / data.length) * 0.1; // Fading noise
                    }
                    
                    const noise = gameState.audioCtx.createBufferSource();
                    noise.buffer = buffer;
                    
                    const bqFilter = gameState.audioCtx.createBiquadFilter();
                    bqFilter.type = "lowpass";
                    bqFilter.frequency.setValueAtTime(600 + Math.random() * 400, gameState.audioCtx.currentTime);
                    
                    noise.connect(bqFilter).connect(gameState.audioCtx.destination);
                    noise.start();
                } catch(e) {
                    console.warn("Could not play creak sound", e);
                }
            }

            // --- GAME LOOP & STATE ---
            function startGameLoop() {
                if (gameState.gameRunning) return;
                gameState.gameRunning = true;

                // Main panic timer
                gameState.timers.panic = setInterval(updatePanic, 1000);
                
                // Random tips
                gameState.timers.tip = setInterval(showRandomTip, 35000);
                setTimeout(() => showTip("Take pills to stay calm."), 5000);
                
                // Random ambient events
                gameState.timers.ambient = setTimeout(triggerRandomEvent, 20000 + Math.random() * 20000);
            }

            function stopGameLoop() {
                gameState.gameRunning = false;
                Object.values(gameState.timers).forEach(timer => {
                    if (timer) clearInterval(timer);
                    if (timer) clearTimeout(timer);
                });
            }

            function updatePanic() {
                if (gameState.gameOver || gameState.pcRebooting) return;

                let panicIncrease = 0.15; // Base rate
                if (gameState.pills <= 2) panicIncrease = 0.25;
                if (gameState.pills === 0) panicIncrease = 0.5;
                if (gameState.currentView === 'pc') panicIncrease *= 1.8; // Panic faster on PC

                if (!gameState.pcOn) {
                    // Slowly decrease panic when PC is off
                    gameState.panic = Math.max(0, gameState.panic - 0.2);
                } else {
                    gameState.panic = Math.min(100, gameState.panic + panicIncrease);
                }
                
                //console.log("Panic:", gameState.panic);
                checkPanicState();
            }

            function checkPanicState() {
                if (gameState.panic >= 80 && !gameState.highPanicActive) {
                    // Start high panic
                    gameState.highPanicActive = true;
                    audioBreathing.currentTime = 0;
                    audioBreathing.play().catch(e => console.warn("Breathing audio failed"));
                    gameContainer.classList.add('high-panic-blur', 'high-panic-shake');
                    panicOverlay.style.opacity = 0.4 + (Math.random() * 0.2);
                    showTip("The breathing is getting closer...");
                } else if (gameState.panic < 80 && gameState.highPanicActive) {
                    // End high panic
                    gameState.highPanicActive = false;
                    audioBreathing.pause();
                    gameContainer.classList.remove('high-panic-blur', 'high-panic-shake');
                    panicOverlay.style.opacity = 0;
                }

                if (gameState.highPanicActive) {
                     panicOverlay.style.opacity = 0.3 + (gameState.panic - 80) / 20 * 0.4;
                }

                if (gameState.panic >= 100) {
                    triggerJumpscare();
                }
            }

            // --- UI & HELPER FUNCTIONS ---
            function showScreen(screenName) {
                Object.values(screens).forEach(s => s.classList.remove('active'));
                if (screens[screenName]) {
                    screens[screenName].classList.add('active');
                    gameState.currentView = screenName;
                }
            }

            function showTip(message) {
                tipsHUD.textContent = message;
                tipsHUD.style.opacity = 1;
                setTimeout(() => {
                    tipsHUD.style.opacity = 0;
                }, 5000);
            }

            function showRandomTip() {
                if (gameState.gameOver) return;
                const tip = tips[Math.floor(Math.random() * tips.length)];
                showTip(tip);
            }

            function triggerRandomEvent() {
                if (gameState.gameOver) return;
                
                // Visual flicker
                const flicker = document.getElementById('flicker-overlay');
                flicker.style.animation = 'none';
                void flicker.offsetWidth; // Trigger reflow
                flicker.style.animation = 'flicker 0.2s 1 step-end';
                
                // Random sound
                if (Math.random() > 0.3) {
                    playCreakSound();
                }

                // Reschedule
                gameState.timers.ambient = setTimeout(triggerRandomEvent, 30000 + Math.random() * 30000); // 30-60s
            }

            // --- PANIC SYSTEM ---
            pillsHUD.addEventListener('click', takePill);

            function takePill() {
                if (gameState.pills > 0 && !gameState.gameOver) {
                    gameState.pills--;
                    pillCount.textContent = gameState.pills;
                    gameState.panic = Math.max(0, gameState.panic - 40); // Significant reduction
                    
                    // Jolt effect
                    gameContainer.style.transition = 'transform 0.1s';
                    gameContainer.style.transform = 'scale(1.02)';
                    setTimeout(() => gameContainer.style.transform = 'scale(1)', 100);

                    checkPanicState(); // Update visuals immediately
                    
                    if (gameState.pills === 0) {
                        showTip("You are out of pills... you're on your own.");
                    }
                }
            }

            // --- ROOM INTERACTIONS ---
            computerHotspot.addEventListener('click', enterPCView);
            mobileBackBtn.addEventListener('click', leavePCView);
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && gameState.device === 'pc' && gameState.currentView === 'pc') {
                    leavePCView();
                }
            });

            function enterPCView() {
                if (gameState.currentView === 'pc' || gameState.gameOver) return;

                gameState.currentView = 'pc';
                screens.room.style.transform = "scale(3.5) translate(-18%, -13%)";
                screens.room.style.opacity = 0.5;
                screens.pc.classList.add('active'); // Fade in
                
                if (gameState.pcRebooting) return; // Already rebooting

                if (!gameState.pcOn) {
                    // Start reboot sequence
                    pcDesktop.style.display = 'none';
                    pcRebooting.style.display = 'block';
                    runRebootSequence();
                } else {
                    // Turn on PC
                    pcDesktop.style.display = 'flex';
                    pcRebooting.style.display = 'none';
                    if (!gameState.currentTask) {
                        taskManager.loadNextTask();
                    }
                    startPCClock();
                }
            }

            function leavePCView() {
                if (gameState.currentView !== 'pc' || gameState.gameOver) return;
                
                gameState.currentView = 'room';
                screens.room.style.transform = "scale(1) translate(0, 0)";
                screens.room.style.opacity = 1;
                screens.pc.classList.remove('active'); // Fade out
                stopPCClock();
            }

            pcPowerOff.addEventListener('click', turnOffPC);

            function turnOffPC() {
                if (!gameState.pcOn) return;
                gameState.pcOn = false;
                gameState.currentTask = null; // Clear current task
                showTip("PC shutting down. Things feel... quieter.");
                leavePCView();
            }

            function runRebootSequence() {
                if (gameState.pcRebooting) return;
                gameState.pcRebooting = true;
                
                const rebootDuration = 30000; // 30 seconds
                rebootBarFill.style.transition = `width ${rebootDuration}ms linear`;
                rebootBarFill.style.width = '100%';

                setTimeout(() => {
                    gameState.pcOn = true;
                    gameState.pcRebooting = false;
                    rebootBarFill.style.transition = 'none';
                    rebootBarFill.style.width = '0%';

                    // If still on PC screen, show desktop
                    if (gameState.currentView === 'pc') {
                        pcDesktop.style.display = 'flex';
                        pcRebooting.style.display = 'none';
                        taskManager.loadNextTask();
                        startPCClock();
                    }
                }, rebootDuration);
            }

            function startPCClock() {
                let time = 0;
                if (gameState.timers.pcClock) clearInterval(gameState.timers.pcClock);
                gameState.timers.pcClock = setInterval(() => {
                    time++;
                    const minutes = String(Math.floor(time / 60)).padStart(2, '0');
                    const seconds = String(time % 60).padStart(2, '0');
                    pcTime.textContent = `${minutes}:${seconds}`;
                }, 1000);
            }

            function stopPCClock() {
                if (gameState.timers.pcClock) clearInterval(gameState.timers.pcClock);
                gameState.timers.pcClock = null;
            }


            // --- TASK MANAGEMENT ---
            const taskManager = {
                currentTaskCleanup: null,
                
                tasks: [
                    { name: "Type Code", init: task_typeCode },
                    { name: "Reaction Test", init: task_clickReaction },
                    { name:css: "Memory Match", init: task_memoryMatch },
                    { name: "Sequence", init: task_sequencePress }
                ],
                
                loadNextTask: function() {
                    if (gameState.tasksCompleted >= gameState.tasksTotal) {
                        winGame();
                        return;
                    }

                    if (this.currentTaskCleanup) {
                        this.currentTaskCleanup();
                        this.currentTaskCleanup = null;
                    }

                    taskContainer.innerHTML = '<h3>Loading new task...</h3>';
                    gameState.currentTask = true; // Mark as having a task

                    setTimeout(() => {
                        const taskIndex = gameState.tasksCompleted % this.tasks.length;
                        this.tasks[taskIndex].init();
                    }, 1000 + Math.random() * 1500);
                },

                completeTask: function() {
                    if (this.currentTaskCleanup) {
                        this.currentTaskCleanup();
                        this.currentTaskCleanup = null;
                    }
                    
                    gameState.tasksCompleted++;
                    gameState.currentTask = null;
                    taskCount.textContent = gameState.tasksTotal - gameState.tasksCompleted;
                    taskContainer.innerHTML = `<h2 style="color: #0f0;">TASK COMPLETE.</h2><p>Calibrating next module...</p>`;
                    
                    // Give a small panic reward
                    gameState.panic = Math.max(0, gameState.panic - 5);
                    
                    setTimeout(this.loadNextTask.bind(this), 2000);
                }
            };

            function task_typeCode() {
                const code = Array(15).fill(0).map(() => "abcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(Math.random() * 36))).join('');
                taskContainer.innerHTML = `
                    <p class="task-description">SECURITY PROTOCOL: Type the following verification code exactly:</p>
                    <h3 id="task-type-code">${code}</h3>
                    <input type="text" id="task-type-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                `;
                
                const input = document.getElementById('task-type-input');
                input.focus();

                const keyHandler = (e) => {
                    if (e.target.value === code) {
                        taskManager.completeTask();
                    } else if (code.startsWith(e.target.value)) {
                        input.style.borderColor = '#444';
                    } else {
                        input.style.borderColor = 'red';
                    }
                };
                input.addEventListener('keyup', keyHandler);
                
                taskManager.currentTaskCleanup = () => {
                    input.removeEventListener('keyup', keyHandler);
                };
            }

            function task_clickReaction() {
                taskContainer.innerHTML = `
                    <p class="task-description">REFLEX CALIBRATION: Click the green square as fast as possible.</p>
                    <div id="task-reaction-grid">
                        ${Array(9).fill(0).map(() => `<div class="reaction-square"></div>`).join('')}
                    </div>
                `;

                const squares = taskContainer.querySelectorAll('.reaction-square');
                const timeoutId = setTimeout(() => {
                    const targetIndex = Math.floor(Math.random() * squares.length);
                    squares[targetIndex].classList.add('target');
                    squares[targetIndex].addEventListener('click', taskManager.completeTask.bind(taskManager), { once: true });
                }, 1500 + Math.random() * 3000);

                taskManager.currentTaskCleanup = () => {
                    clearTimeout(timeoutId);
                    squares.forEach(sq => sq.replaceWith(sq.cloneNode(true))); // Remove listeners
                };
            }

            function task_memoryMatch() {
                taskContainer.innerHTML = `
                    <p class="task-description">COGNITIVE TEST: Match all pairs.</p>
                    <div id="task-memory-grid"></div>
                `;
                
                const grid = document.getElementById('task-memory-grid');
                const symbols = ['★', '★', '❖', '❖', '♦', '♦', 'Ω', 'Ω'];
                symbols.sort(() => 0.5 - Math.random()); // Shuffle

                let flippedCards = [];
                let matchedPairs = 0;
                let handlingClick = false;

                symbols.forEach((symbol, index) => {
                    const card = document.createElement('div');
                    card.classList.add('memory-card');
                    card.dataset.symbol = symbol;
                    card.dataset.index = index;
                    card.innerHTML = `<span>${symbol}</span>`;
                    grid.appendChild(card);
                });

                const clickHandler = (e) => {
                    const clickedCard = e.target.closest('.memory-card');
                    if (!clickedCard || handlingClick || clickedCard.classList.contains('flipped') || clickedCard.classList.contains('matched')) {
                        return;
                    }

                    handlingClick = true;
                    clickedCard.classList.add('flipped');
                    flippedCards.push(clickedCard);

                    if (flippedCards.length === 2) {
                        // Check for match
                        if (flippedCards[0].dataset.symbol === flippedCards[1].dataset.symbol) {
                            flippedCards.forEach(card => card.classList.add('matched'));
                            matchedPairs++;
                            flippedCards = [];
                            handlingClick = false;
                            
                            if (matchedPairs === symbols.length / 2) {
                                setTimeout(taskManager.completeTask.bind(taskManager), 500);
                            }
                        } else {
                            // No match
                            setTimeout(() => {
                                flippedCards.forEach(card => card.classList.remove('flipped'));
                                flippedCards = [];
                                handlingClick = false;
                            }, 1000);
                        }
                    } else {
                        handlingClick = false;
                    }
                };

                grid.addEventListener('click', clickHandler);
                taskManager.currentTaskCleanup = () => {
                    grid.removeEventListener('click', clickHandler);
                };
            }

            function task_sequencePress() {
                taskContainer.innerHTML = `
                    <p class="task-description">PATTERN RECOGNITION: Press the buttons in the correct sequence.</p>
                    <div id="task-sequence-display" style="font-size: 2rem; margin: 20px 0; letter-spacing: 10px; color: #ff0;"></div>
                    <div id="task-sequence-buttons">
                        <button data-seq="1">1</button>
                        <button data-seq="2">2</button>
                        <button data-seq="3">3</button>
                        <button data-seq="4">4</button>
                    </div>
                    <p id="task-sequence-input" style="font-size: 1.5rem; margin-top: 20px;"></p>
                `;

                const display = document.getElementById('task-sequence-display');
                const buttons = document.getElementById('task-sequence-buttons');
                const inputDisplay = document.getElementById('task-sequence-input');

                const sequence = Array(5).fill(0).map(() => Math.floor(Math.random() * 4) + 1);
                let playerInput = [];
                
                display.textContent = sequence.join('');

                const clickHandler = (e) => {
                    if (!e.target.matches('button[data-seq]')) return;
                    
                    const val = e.target.dataset.seq;
                    playerInput.push(val);
                    inputDisplay.textContent = playerInput.join('');

                    // Check input
                    if (sequence[playerInput.length - 1] != val) {
                        // Wrong, reset
                        inputDisplay.style.color = 'red';
                        setTimeout(() => {
                            playerInput = [];
                            inputDisplay.textContent = '';
                            inputDisplay.style.color = '#ccc';
                        }, 500);
                    } else if (playerInput.length === sequence.length) {
                        // Correct
                        inputDisplay.style.color = 'green';
                        setTimeout(taskManager.completeTask.bind(taskManager), 500);
                    }
                };
                
                buttons.addEventListener('click', clickHandler);
                taskManager.currentTaskCleanup = () => {
                    buttons.removeEventListener('click', clickHandler);
                };
            }


            // --- JUMPSCARE HANDLER ---
            function triggerJumpscare() {
                if (gameState.gameOver) return;
                console.log("GAME OVER");
                gameState.gameOver = true;
                stopGameLoop();

                // Reset all visuals
                gameContainer.className = '';
                panicOverlay.style.opacity = 0;
                Object.values(screens).forEach(s => s.classList.remove('active'));

                // Stop all audio
                audioBreathing.pause();
                if (gameState.ambientHum) gameState.ambientHum.stop();
                
                // Play jumpscare
                jumpscareVideo.style.display = 'block';
                jumpscareVideo.currentTime = 0;
                jumpscareVideo.play().catch(e => {
                    console.error("Jumpscare video failed to play", e);
                    // Fallback if video fails
                    showGameOver();
                });
            }

            jumpscareVideo.addEventListener('ended', showGameOver);
            jumpscareVideo.addEventListener('error', showGameOver); // Fallback

            function showGameOver() {
                jumpscareVideo.style.display = 'none';
                showScreen('gameOver');
            }

            // --- WIN / LOSE CONDITIONS ---
            function winGame() {
                if (gameState.gameOver) return;
                console.log("YOU WIN");
                gameState.gameOver = true;
                stopGameLoop();
                
                audioBreathing.pause();
                if (gameState.ambientHum) gameState.ambientHum.stop();

                leavePCView();
                setTimeout(() => {
                    showScreen('win');
                }, 1500); // Wait for zoom out
            }

            // --- RESTART ---
            document.getElementById('restart-btn').addEventListener('click', () => location.reload());
            document.getElementById('restart-btn-win').addEventListener('click', () => location.reload());

        });
    </script>
</body>
</html>

